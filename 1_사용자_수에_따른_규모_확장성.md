# 1장. 사용자 수에 따른 규모 확장성

### 단일 서버
- 사용자 요청 처리 흐름
    - 사용자는 도메인 이름(api.mysite.com)을 통해 웹 사이트 접근 
    - DNS 조회 결과로 IP 주소 반환 (15.125.23.214)
    - 해당 IP 주소로 HTTP 요청 전달
    - 요청을 받은 웹 서버는 JSON 형태 응답 

- 해당 요청은 어디에서부터 올까?
    - 웹 앱 or 모바일 앱 

### 데이터베이스
- 사용자가 늘면 서버 하나로는 충분하지 않음 -> 여러 서버 필요
    - 하나는 웹/모바일 트래픽 처리용 / 다른 하나는 데이터베이스용

- 어떤 데이터베이스를 사용해야 하는가?
    - 보통은 RDB.. 그러나 다음과 같은 경우에는 NoSQL
        - 아주 낮은 응답 지연시간이 필요
        - 다루는 데이터가 비정형
        - 데이터를 직렬화하거나, 역직렬화하는 정도의 작업만이 요구됨
        - 아주 많은 양의 데이터

### 수직적 규모 확장 vs 수평적 규모 확장
- 스케일 업 
    - 서버에 고사양 자원을 추가하는 행위
- 스케일 아웃
    - 더 많은 서버를 추가하는 행위

- 스케일 업의 단점으로 인해 보통 스케일 아웃 선택..
    - 수직적 규모 확장은 한계가 있음 -> 한 대의 서버에 메모리 무한대 증설 ㄷㄷ
    - 수직적 규모 확장은 자동복구 방안이나 다중화 방안을 제시하지 않음

### 로드밸런서
- 부하 분산 집합에 속한 웹 서버들에게 트래픽 부하를 고르게 분산한다.

- 로드밸런서의 동작  
    - 사용자는 로드밸런서의 공개 IP 주소로 접근한다.
    - 서버 1인 다운되면 모든 트래픽은 서버2로 전송 (부하가 나누어짐)
    - 점점 더 트래픽이 증가하면? -> 더 많은 서버를 증설하면 됨 -> 로드밸런스가 알아서 분산해줌~ 

##### 데이터베이스 다중화
- 많은 데이터베이스 관리 시스템이 다중화를 지원함
    - 주-부 관계를 설정하고 데이터 원본은 주 서버에, 사본은 부 서버에 저장함

- 장점
    - 더 나은 성능
        - 주-부 다중화 모델에서 모든 데이터 볍ㄴ경 연산은 주 데이터베이스 서버로만 전달되는 반면 읽기 연산은 부 데이터베이스 서버들로 분산됨
        - 병렬로 처리될 수 있는 질의(query)의 수가 늘어나므로, 성능이 좋아짐
    - 안전성
        - 자연 재해 등의 이유로 데이터베이스 서버 가운데 일부가 파괴되어도 데이터는 보존됨
    - 가용성
        - 데이터를 여러 지역에 복제해 둠으로써, 하나의 데이터베이스 서버에 장애가 발생하더라도 다른 서버에 있는 데이터를 가져와 게속 서비스할 수 있게 됨

### 캐시
- 캐시는 값비싼 연산 결과 또는 자주 참조되는 데이터를 메모리 안에 두고, 뒤이은 요청이 보다 빨리 처리될 수 있도록 하는 저장소
- 켸시 계층을 두면 성능 개선 및 DB 부하를 줄임 

- 흐름
    - 요청 받은 웹 서버는 캐시에 응답이 저장되어 있는지 확인 -> 저장되어 있으면 해당 데이터를 클라이언트에 반환

- 유의할 점
    - 어떤 데이터를 캐시에 두어야 할까?
    - 캐이세 보관된 데이터는 어떻게 만료되는가?
    - 일관성은 어떻게 유지되는가?
    - 장애는 어떻게 대처할 것인가 
    - 이외에도 ㅐ시 메모리 크기, 데이터 방출 정책 등등....

### 콘텐츠 전송 네트워크 (CDN)
- 정적 콘텐츠를 전송하는 데 쓰이는, 지리적으로 분산된 서버의 네트워크 

- 동작 방법
    - 사용자 A가 이미지 URL을 이용해 image.png에 접근 -> ULR의 도메인은 CDN 서비스 사업자가 제공한 것
    - CDN 서버의 캐시에 해당 이미지가 없으면? -> 원본 서버에 요청 
    - 원본 서버가 파일을 CDN 서버에 반환 
    - CDN 서버는 파일을 캐시하고 사용자 A에게 반환,..

### 무상태 웹 계층
- 웹 계층을 수평적으로 확장하려면? -> 세션과 같은 상태 정보를 웹 계층에서 제거해야 함
    - 상태 정보를 관계형 데이터베이스나 NoSQL 같은 지속성 저장소에 보관하고, 필요할 때 가져오도록 함

### 데이터 센터
- 사용자는 가장 가까운 데이터 센터로 안내된다. -> 지리적 라우팅
    - geoDNS는 사용자의 위치에 따라 도메인 이름을 어떤 IP 주소로 변환할지 결정할 수 있도록 해주는 DNS 서비스 

- 다중 데이터센터 아키텍처를 만들려면 몇가지 기술적 난제 해결 필요
    - 트래픽 우회
    - 데이터 동기화
    - 테스트와 배포 

### 메세지 큐
- 메세지 큐에 일단 보관된 메시지는 소비가가 꺼낼 때까지 안전히 보관된다는 특성을 보장하는 컴포넌트

- 기본 아키텍처
    - 생산자 또는 발행자라고 불리는 입력 서비스가 메시지를 만들어 메시지 큐에 발행
    - 소비자 혹은 구독자가 메세지를 받아 그에 맞는 동작을 수행


### 데이터베이스의 규모 확장
- 저장할 데이터가 많아지면 데이터베이스에 대한 부하도 증가한다. 

##### 수직적 확장
- 스케일 업이라고도 부르는 수직적 규모 확장법은 기존 서버에 고성능의 자원을 증설하는 방법이다.
- 그러나 역시 무한 증설할수 없고, 단일 장애 지점으로 인한 위험성이 크고, 비용이 많이 듦!

##### 수평적 확장
- 샤딩이라고도 한다.
    - 대규모 데이터베이스를 샤드라고 부르는 작은 단위로 분할하는 기술을 일컫는다.
    - 가장 중요한 건 샤딩 키(=파티션 키)를 어떻게 정하느냐이다.
    - 고려할 점
        - 데이터의 재 샤딩
        - 유명인사 문제: 특정 샤드에 질의가 집중
        - 조인과 비정규화
         